<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WinGo Game</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f8f9fa; padding: 20px; }
    h1, h2 { margin: 10px 0; }
    button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
    input { padding: 8px; width: 100px; font-size: 16px; }
    #history { margin-top: 20px; }
    .red { color: red; font-weight: bold; }
    .green { color: green; font-weight: bold; }
    .violet { color: purple; font-weight: bold; }
  </style>
</head>
<body>
  <h1>WinGo Game</h1>

  <div>
    <p><strong>User:</strong> <span id="username"></span></p>
    <p><strong>Time Left:</strong> <span id="timer">30</span> seconds</p>
    <p><strong>Current Result:</strong> <span id="result">Loading...</span></p>
    <p><strong>Profit:</strong> <span id="profit">Loading...</span></p>
  </div>

  <div>
    <input type="number" id="betAmount" placeholder="Amount" min="1" />
    <br />
    <button onclick="placeBet('Red')">Red</button>
    <button onclick="placeBet('Green')">Green</button>
    <button onclick="placeBet('Violet')">Violet</button>
  </div>

  <h3>Last 10 Game Results</h3>
  <div id="history">Loading history...</div>

  <script>
    const API = 'https://wingo-backend-nqk5.onrender.com';
    const username = localStorage.getItem('username');
    document.getElementById("username").textContent = username || "Unknown";

    let timer = 30;

    function updateTimer() {
      timer--;
      if (timer <= 0) {
        timer = 30;
        loadCurrentResult();
        loadGameHistory();
        loadProfit();
      }
      document.getElementById("timer").textContent = timer;
    }

    async function placeBet(color) {
      const amount = document.getElementById("betAmount").value;
      if (!amount || isNaN(amount) || amount <= 0) {
        alert("Please enter a valid amount");
        return;
      }

      try {
        // Get latest round
        const roundRes = await fetch(`${API}/api/rounds`);
        const rounds = await roundRes.json();
        const latestRound = rounds[rounds.length - 1];
        if (!latestRound || !latestRound._id) {
          alert("No active round found.");
          return;
        }

        const res = await fetch(`${API}/api/bets`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username,
            color,
            amount,
            roundId: latestRound._id,
            timestamp: new Date()
          })
        });

        const data = await res.json();
        if (res.ok) {
          alert("Bet placed on " + color);
          loadProfit();
        } else {
          alert(data.message || "Error placing bet");
        }
      } catch (err) {
        console.error(err);
        alert("Error placing bet");
      }
    }

    async function loadCurrentResult() {
      try {
        const res = await fetch(`${API}/api/rounds`);
        const data = await res.json();
        const latest = data.find(r => r.result);
        if (latest) {
          const colorClass = latest.result.toLowerCase();
          document.getElementById("result").innerHTML =
            `<span class="${colorClass}">${latest.result}</span>`;
        } else {
          document.getElementById("result").textContent = "Pending...";
        }
      } catch (err) {
        document.getElementById("result").textContent = "Error loading result";
      }
    }

    async function loadGameHistory() {
      try {
        const res = await fetch(`${API}/api/rounds`);
        const data = await res.json();
        const recentRounds = data.reverse().filter(r => r.result).slice(0, 10);

        const html = recentRounds.map(r =>
          `<div>Round ${r._id.slice(-4)} → 
           <span class="${r.result.toLowerCase()}">${r.result}</span></div>`
        ).join('');

        document.getElementById("history").innerHTML = html;
      } catch (err) {
        document.getElementById("history").textContent = "Error loading history";
      }
    }

    async function loadProfit() {
      try {
        const res = await fetch(`${API}/api/bets/profit/${username}`);
        const data = await res.json();
        document.getElementById("profit").innerText = `₹${data.profit}`;
      } catch (err) {
        document.getElementById("profit").innerText = "Error";
      }
    }

    setInterval(updateTimer, 1000);

    // Initial load
    loadCurrentResult();
    loadGameHistory();
    loadProfit();
  </script>
</body>
</html>
