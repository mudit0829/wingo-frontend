<!DOCTYPE html>
<html>
<head>
  <title>WinGo Game</title>
</head>
<body>
  <h2>Welcome, <span id="userName"></span>!</h2>
  <p>Role: <span id="userRole"></span></p>
  <button onclick="logout()">Logout</button>

  <h3>Place Your Bet</h3>
  <label>Choose Color:</label>
  <select id="color">
    <option value="Red">Red</option>
    <option value="Green">Green</option>
    <option value="Violet">Violet</option>
  </select>
  <button onclick="placeBet()">Place Bet</button>
  <p id="betMessage"></p>

  <h3>Your Recent Bets</h3>
  <div id="betHistory">Loading...</div>

  <script>
    const username = localStorage.getItem("username");
    const role = localStorage.getItem("role");

    if (!username) {
      window.location.href = "index.html";
    }

    document.getElementById("userName").textContent = username;
    document.getElementById("userRole").textContent = role;

    async function placeBet() {
      const color = document.getElementById("color").value;
      const amount = parseInt(prompt("Enter your bet amount:"));

      if (!amount || isNaN(amount)) {
        document.getElementById("betMessage").textContent = "âŒ Please enter a valid amount.";
        return;
      }

      try {
        // Fetch latest round
        const roundsRes = await fetch("https://wingo-backend-nqk5.onrender.com/api/rounds");
        const rounds = await roundsRes.json();
        const roundId = rounds[0]?.roundId;

        const response = await fetch("https://wingo-backend-nqk5.onrender.com/api/bets", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, color, amount, roundId })
        });

        const data = await response.json();

        if (response.ok) {
          document.getElementById("betMessage").textContent = "âœ… Bet placed!";
          loadBetHistory(); // Refresh history after bet
        } else {
          document.getElementById("betMessage").textContent = "âŒ " + (data.message || "Error placing bet");
        }
      } catch (error) {
        document.getElementById("betMessage").textContent = "âŒ Network error";
      }
    }

    async function loadBetHistory() {
      try {
        const res = await fetch(`https://wingo-backend-nqk5.onrender.com/api/bets/${username}`);
        const data = await res.json();

        const betDiv = document.getElementById("betHistory");
        if (!data.length) {
          betDiv.innerHTML = "No bets placed yet.";
          return;
        }

        betDiv.innerHTML = data.map(bet => `
          <div>
            ðŸ§¾ <b>Round:</b> ${bet.roundId} |
            ðŸŽ¨ <b>Color:</b> ${bet.color} |
            ðŸ’° <b>Amount:</b> â‚¹${bet.amount} |
            ðŸ“… <b>Status:</b> ${bet.status || 'Pending'}
          </div>
        `).join("<hr>");
      } catch (err) {
        document.getElementById("betHistory").innerHTML = "Error loading bet history.";
      }
    }

    function logout() {
      localStorage.clear();
      window.location.href = "index.html";
    }

    // Load history on page load
    loadBetHistory();
  </script>
</body>
</html>
