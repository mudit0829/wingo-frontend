<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WinGo Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f9;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 {
      color: #0066cc;
    }
    .wallet, .bet-section, .result, .controls {
      margin-bottom: 20px;
    }
    button {
      padding: 10px;
      margin: 5px;
      cursor: pointer;
      border-radius: 5px;
      border: none;
      background-color: #007bff;
      color: white;
    }
    button:hover {
      background-color: #0056b3;
    }
    .selected {
      background-color: #28a745 !important;
    }
  </style>
</head>
<body>

  <h1>WinGo Game</h1>

  <div class="wallet">
    <strong>Wallet:</strong> ₹<span id="walletAmount">0</span>
  </div>

  <div class="controls">
    <button onclick="adjustAmount(-10)">-10</button>
    <button onclick="adjustAmount(-1)">-1</button>
    <span id="amountDisplay">₹0</span>
    <button onclick="adjustAmount(1)">+1</button>
    <button onclick="adjustAmount(10)">+10</button>
  </div>

  <div class="bet-section">
    <h3>Choose Color Bet</h3>
    <button onclick="selectBet('Red', null)">Red</button>
    <button onclick="selectBet('Green', null)">Green</button>
    <button onclick="selectBet('Violet', null)">Violet</button>

    <h3>Choose Number Bet</h3>
    <div id="numberButtons"></div>
  </div>

  <div class="result">
    <h3>Result:</h3>
    <p id="resultMessage">No result yet</p>
  </div>

  <button onclick="placeBet()">Place Bet</button>

  <script>
    const backendUrl = "https://wingo-backend-nqk5.onrender.com";
    const email = "test2@example.com"; // HARD-CODED DEMO USER
    let currentAmount = 0;
    let selectedBet = { type: null, number: null };

    // Amount Control
    function adjustAmount(amount) {
      currentAmount = Math.max(0, currentAmount + amount);
      document.getElementById("amountDisplay").innerText = `₹${currentAmount}`;
    }

    // Color/Number Selection
    function selectBet(type, number) {
      selectedBet = { type, number };
      document.querySelectorAll("button").forEach(btn => btn.classList.remove("selected"));
      event.target.classList.add("selected");
    }

    // Generate Number Buttons 0-9
    window.onload = async () => {
      for (let i = 0; i <= 9; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;
        btn.onclick = () => selectBet(null, i);
        document.getElementById("numberButtons").appendChild(btn);
      }
      await fetchWallet();
    };

    // Get Wallet Amount
    async function fetchWallet() {
      try {
        const res = await fetch(`${backendUrl}/api/users/${email}`);
        const data = await res.json();
        document.getElementById("walletAmount").innerText = data.wallet.toFixed(2);
      } catch (err) {
        alert("Error fetching wallet!");
      }
    }

    // Get Current Round ID from backend
    async function fetchCurrentRoundId() {
      const res = await fetch(`${backendUrl}/api/rounds`);
      const data = await res.json();
      const latestRound = data[data.length - 1];
      return latestRound.roundId;
    }

    // Place Bet API
    async function placeBet() {
      try {
        if (!currentAmount || (!selectedBet.type && selectedBet.number === null)) {
          alert("Please select a bet and amount!");
          return;
        }

        const roundId = await fetchCurrentRoundId();
        const payload = {
          email,
          roundId,
          amount: currentAmount,
          colorBet: selectedBet.number === null ? selectedBet.type : null,
          numberBet: selectedBet.number !== null ? selectedBet.number : null
        };

        const res = await fetch(`${backendUrl}/api/bets`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.message || "Bet failed");
        }

        document.getElementById("resultMessage").innerText = `✅ Bet placed on round ${roundId}`;
        currentAmount = 0;
        document.getElementById("amountDisplay").innerText = "₹0";
        selectedBet = { type: null, number: null };
        await fetchWallet();
      } catch (err) {
        console.error(err);
        document.getElementById("resultMessage").innerText = `❌ ${err.message}`;
      }
    }
  </script>
</body>
</html>
