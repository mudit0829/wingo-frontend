<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WinGo Game</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
    .btn { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; }
    .red { background-color: red; color: white; }
    .green { background-color: green; color: white; }
    .violet { background-color: violet; color: white; }
    .number { background-color: lightgray; }
    .amounts { margin: 10px 0; }
    .result { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>WinGo Game</h1>
  <h3>User: user@example.com</h3>
  <div>Wallet: ‚Çπ<span id="wallet">--</span></div>

  <div class="amounts">
    <label>Enter Bet Amount:</label>
    <input type="number" id="amountInput" value="100" min="1"/>
  </div>

  <div>
    <h3>Select Color:</h3>
    <button class="btn red" onclick="selectColor('Red')">Red</button>
    <button class="btn green" onclick="selectColor('Green')">Green</button>
    <button class="btn violet" onclick="selectColor('Violet')">Violet</button>
  </div>

  <div>
    <h3>OR Select Number:</h3>
    <div>
      <button class="btn number" onclick="selectNumber(n)" id="nBtn" style="margin:2px;" 
        >0</button>
    </div>
    <div id="numberButtons"></div>
  </div>

  <button class="btn" style="background-color: blue; color: white; margin-top: 15px;" onclick="placeBet()">Place Bet</button>

  <div class="result" id="betResult"></div>

  <script>
    const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2ODg5ZmUxNWE3N2UxMzI2YTY3NDBmZmUiLCJlbWFpbCI6InVzZXJAZXhhbXBsZS5jb20iLCJpYXQiOjE3NTM5NDg3MjAsImV4cCI6MTc1Mzk1OTUyMH0.UTgEb2MlisIpjGxLRmhY-fqm80AEcaTMpUd2p2Mrv3k";
    const apiBase = "https://wingo-backend-nqk5.onrender.com";
    const email = "user@example.com";
    let selectedBet = { type: null, number: null };
    let currentRoundId = null;

    function selectColor(color) {
      selectedBet = { type: color, number: null };
      document.getElementById("betResult").textContent = `Selected Color: ${color}`;
    }

    function selectNumber(num) {
      selectedBet = { type: null, number: num };
      document.getElementById("betResult").textContent = `Selected Number: ${num}`;
    }

    // Generate 0-9 number buttons
    const numBtns = document.getElementById("numberButtons");
    for (let i = 0; i < 10; i++) {
      const btn = document.createElement("button");
      btn.className = "btn number";
      btn.textContent = i;
      btn.onclick = () => selectNumber(i);
      numBtns.appendChild(btn);
    }

    async function fetchCurrentRound() {
      try {
        const res = await fetch(`${apiBase}/api/rounds`);
        const data = await res.json();
        if (data.length > 0) {
          currentRoundId = data[data.length - 1]._id;
        }
      } catch (err) {
        console.error("Failed to fetch current round", err);
      }
    }

    async function fetchWallet() {
      try {
        const res = await fetch(`${apiBase}/api/users/email/${email}`);
        const data = await res.json();
        document.getElementById("wallet").textContent = data.wallet.toFixed(2);
      } catch (err) {
        document.getElementById("wallet").textContent = "--";
        console.error("Error fetching wallet", err);
      }
    }

    async function placeBet() {
      if (!currentRoundId) {
        document.getElementById("betResult").textContent = "Please wait... Round not loaded.";
        return;
      }

      const amount = parseFloat(document.getElementById("amountInput").value);
      if (!amount || amount <= 0) {
        alert("Enter valid amount.");
        return;
      }

      const payload = {
        email,
        roundId: currentRoundId,
        amount,
        colorBet: selectedBet.number === null ? selectedBet.type : null,
        numberBet: selectedBet.number !== null ? selectedBet.number : null
      };

      try {
        const res = await fetch(`${apiBase}/api/bets`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("Bet failed");

        const data = await res.json();
        document.getElementById("betResult").textContent = `‚úÖ Bet Placed Successfully! Waiting for result...`;
        await fetchWallet();

        // Auto-fetch result after 6 seconds
        setTimeout(() => checkResult(payload), 6000);

      } catch (err) {
        console.error("Place Bet Error:", err);
        document.getElementById("betResult").textContent = "‚ùå Failed to place bet.";
      }
    }

    async function checkResult(payload) {
      try {
        const res = await fetch(`${apiBase}/api/rounds`);
        const rounds = await res.json();
        const myRound = rounds.find(r => r._id === payload.roundId);
        if (!myRound || myRound.result === null) {
          document.getElementById("betResult").textContent += "\n‚ùó Result not yet available.";
          return;
        }

        let won = false;
        let winAmount = 0;

        if (payload.colorBet) {
          if (
            (payload.colorBet === "Red" && [1,3,7,9].includes(myRound.result)) ||
            (payload.colorBet === "Green" && [0,2,4,6,8].includes(myRound.result)) ||
            (payload.colorBet === "Violet" && [0,5].includes(myRound.result))
          ) {
            won = true;
            winAmount = 98 * (payload.colorBet === "Violet" ? 4.5 : ([0,5].includes(myRound.result) ? 1.5 : 2));
          }
        }

        if (payload.numberBet !== null && payload.numberBet === myRound.result) {
          won = true;
          winAmount += 98 * 9;
        }

        if (won) {
          document.getElementById("betResult").textContent += `\nüéâ You WON! +‚Çπ${winAmount.toFixed(2)}`;
        } else {
          document.getElementById("betResult").textContent += "\nüòû You lost.";
        }

        await fetchWallet();

      } catch (err) {
        console.error("Result Fetch Error", err);
      }
    }

    // Init
    fetchCurrentRound();
    fetchWallet();
  </script>
</body>
</html>
