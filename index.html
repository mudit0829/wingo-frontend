<!-- index.html (Updated with Wallet Deduction Logic) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WinGo Game</title>
  <style>
    /* (All Your Existing CSS Unchanged) */
    body { font-family: Arial, sans-serif; background-color: #101010; color: #fff; margin: 0; padding: 0; text-align: center; }
    .wallet-section { margin: 10px auto; }
    .wallet-section h3 { margin: 0; font-size: 18px; }
    .wallet-section .wallet-buttons { margin-top: 5px; }
    .wallet-buttons button { margin: 3px; padding: 5px 10px; background: #1e90ff; border: none; border-radius: 4px; color: white; cursor: pointer; }
    .round-info { font-size: 14px; margin: 10px 0; }
    .timer { font-size: 20px; margin-bottom: 10px; }
    .number-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; max-width: 300px; margin: 10px auto; }
    .number-button { background-color: #444; color: #fff; border: none; padding: 10px; font-size: 18px; cursor: pointer; border-radius: 5px; }
    .color-options { margin: 15px; }
    .color-button { margin: 5px; padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; }
    .color-red { background-color: red; color: white; }
    .color-green { background-color: green; color: white; }
    .color-violet { background-color: purple; color: white; }
    .popup { position: fixed; bottom: -100%; left: 0; right: 0; background-color: #222; padding: 20px; transition: bottom 0.3s; border-top-left-radius: 15px; border-top-right-radius: 15px; }
    .popup.show { bottom: 0; }
    .bet-options, .multiplier-options { display: flex; justify-content: center; margin: 10px 0; flex-wrap: wrap; }
    .bet-options button, .multiplier-options button { margin: 5px; padding: 10px; font-size: 14px; border: none; border-radius: 4px; cursor: pointer; background-color: #555; color: white; }
    .history { margin-top: 20px; padding: 10px; }
    .history h3 { border-bottom: 1px solid #555; padding-bottom: 5px; }
    .history-table { width: 90%; margin: auto; border-collapse: collapse; }
    .history-table th, .history-table td { border: 1px solid #666; padding: 5px; font-size: 12px; }
    .btn-primary { background: #28a745; }
    .btn-cancel { background: #dc3545; }
  </style>
</head>
<body>

<!-- (HTML Structure Unchanged) -->
<h1>üéØ WinGo Game üéØ</h1>
<div class="wallet-section">
  <h3>Wallet: <span id="walletAmount">‚Çπ0.00</span></h3>
  <div class="wallet-buttons">
    <button onclick="alert('Deposit clicked')">Deposit</button>
    <button onclick="alert('Withdraw clicked')">Withdraw</button>
  </div>
</div>

<div class="round-info">Round: <span id="roundId">-</span></div>
<div class="timer" id="timer">--s</div>

<div class="color-options">
  <button class="color-button color-red" onclick="selectColor('Red')">Red</button>
  <button class="color-button color-green" onclick="selectColor('Green')">Green</button>
  <button class="color-button color-violet" onclick="selectColor('Violet')">Violet</button>
</div>

<div class="number-grid" id="numberGrid"></div>

<div id="popup" class="popup">
  <h3 id="betTitle">Place Your Bet</h3>
  <div class="bet-options">
    <button onclick="addAmount(1)">‚Çπ1</button>
    <button onclick="addAmount(5)">‚Çπ5</button>
    <button onclick="addAmount(10)">‚Çπ10</button>
    <button onclick="addAmount(100)">‚Çπ100</button>
  </div>
  <div class="multiplier-options">
    <button onclick="setMultiplier(2)">x2</button>
    <button onclick="setMultiplier(5)">x5</button>
    <button onclick="setMultiplier(10)">x10</button>
    <button onclick="setMultiplier(100)">x100</button>
  </div>
  <div>
    <p>Total Amount: ‚Çπ<span id="totalAmount">0</span></p>
    <input type="hidden" id="betAmount" value="0"/>
    <button class="btn-primary" onclick="placeBet()">Place Bet</button>
    <button class="btn-cancel" onclick="closePopup()">Cancel</button>
  </div>
</div>

<div class="history">
  <h3>üóæ My History</h3>
  <table class="history-table" id="myHistoryTable">
    <tr><th>Round</th><th>Color</th><th>Number</th><th>Amount</th><th>Status</th></tr>
  </table>
</div>
  <div>
  <button onclick="prevMyHistoryPage()">‚¨ÖÔ∏è Prev</button>
  <button onclick="nextMyHistoryPage()">Next ‚û°Ô∏è</button>
</div>


<div class="history">
  <h3>üé≤ Game History</h3>
  <table class="history-table" id="gameHistoryTable">
    <tr><th>Round</th><th>Color</th><th>Number</th><th>Time</th></tr>
  </table>
</div>
  <div>
  <button onclick="prevGameHistoryPage()">‚¨ÖÔ∏è Prev</button>
  <button onclick="nextGameHistoryPage()">Next ‚û°Ô∏è</button>
</div>


<script>
const apiUrl = "https://wingo-backend-nqk5.onrender.com";
let selectedColor = null;
let selectedNumber = null;
let totalAmount = 0;
let multiplier = 1;
let currentEmail = localStorage.getItem("userEmail") || "user@example.com";
let currentRoundId = "";
let roundTimerInterval;
let isBettingClosed = false;
let resultBufferActive = false;

let myHistoryPage = 0;
let gameHistoryPage = 0;
const pageSize = 10;
let allUserBets = [];
let allRounds = [];

function selectColor(color) {
  if (isBettingClosed) return;
  selectedColor = color;
  selectedNumber = null;
  openBetPopup(color);
}

function renderNumberButtons() {
  const grid = document.getElementById("numberGrid");
  grid.innerHTML = "";
  for (let i = 0; i < 10; i++) {
    const btn = document.createElement("button");
    btn.className = "number-button";
    btn.textContent = i;
    btn.onclick = () => {
      if (isBettingClosed) return;
      selectedNumber = i;
      selectedColor = null;
      openBetPopup(`Number ${i}`);
    };
    grid.appendChild(btn);
  }
}

function openBetPopup(label) {
  document.getElementById("betTitle").textContent = `Place Bet on ${label}`;
  document.getElementById("popup").classList.add("show");
}

function closePopup() {
  document.getElementById("popup").classList.remove("show");
  totalAmount = 0;
  multiplier = 1;
  selectedColor = null;
  selectedNumber = null;
  document.getElementById("totalAmount").textContent = totalAmount;
  document.getElementById("betAmount").value = totalAmount;
}

function addAmount(amount) {
  totalAmount += amount;
  updateAmount();
}

function setMultiplier(mult) {
  multiplier = mult;
  updateAmount();
}

function updateAmount() {
  const calculated = totalAmount * multiplier;
  document.getElementById("totalAmount").textContent = calculated;
  document.getElementById("betAmount").value = calculated;
}

async function fetchWalletBalance() {
  try {
    const res = await fetch(`${apiUrl}/api/users/wallet/${currentEmail}`);
    const data = await res.json();
    const bal = data.wallet ?? data.balance ?? 0;
    document.getElementById("walletAmount").innerText = `‚Çπ${bal.toFixed(2)}`;
  } catch (err) {
    console.error("Wallet fetch:", err);
  }
}

async function fetchCurrentRound() {
  try {
    const res = await fetch(`${apiUrl}/api/rounds`);
    const rounds = await res.json();
    if (!rounds || rounds.length === 0) return;
    const round = rounds[0];

    const start = new Date(round.startTime).getTime();
    const now = Date.now();
    const elapsed = Math.floor((now - start) / 1000);
    const left = 30 - elapsed;

    currentRoundId = round.roundId;
    document.getElementById("roundId").textContent = round.roundId.slice(-5);

    if (left <= 5 && !isBettingClosed) {
      isBettingClosed = true;
      disableBettingButtons();
    }

    if (left <= 0 && !resultBufferActive) {
      resultBufferActive = true;
      document.getElementById("timer").textContent = "Result in 3s...";
      setTimeout(() => {
        fetchWalletBalance();
        loadMyHistoryPaginated();
        fetchGameHistoryPaginated();
        isBettingClosed = false;
        resultBufferActive = false;
        enableBettingButtons();
      }, 3000);
    } else if (left > 0) {
      document.getElementById("timer").textContent = `${left}s`;
    }

  } catch (err) {
    console.error("Fetch round:", err);
  }
}

function disableBettingButtons() {
  document.querySelectorAll(".color-button, .number-button").forEach(btn => {
    btn.disabled = true;
    btn.style.opacity = "0.5";
  });
}

function enableBettingButtons() {
  document.querySelectorAll(".color-button, .number-button").forEach(btn => {
    btn.disabled = false;
    btn.style.opacity = "1";
  });
}

function startRoundTimer() {
  clearInterval(roundTimerInterval);
  fetchCurrentRound();
  roundTimerInterval = setInterval(fetchCurrentRound, 1000);
}

async function placeBet() {
  try {
    const amount = parseInt(document.getElementById("betAmount").value);
    if (!currentEmail || !currentRoundId || !amount) throw new Error("Missing fields");
    const payload = {
      email: currentEmail,
      roundId: currentRoundId,
      amount,
      ...(selectedColor && { colorBet: selectedColor }),
      ...(selectedNumber != null && { numberBet: selectedNumber }),
    };
    const res = await fetch(`${apiUrl}/api/bets`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || "Bet failed");
    alert("‚úÖ Bet placed!");
    closePopup();

    // Deduct Wallet Instantly in UI
    const currentWallet = parseFloat(document.getElementById("walletAmount").innerText.replace('‚Çπ', ''));
    document.getElementById("walletAmount").innerText = `‚Çπ${(currentWallet - amount).toFixed(2)}`;

    loadMyHistoryPaginated();
  } catch (err) {
    console.error("Place Bet:", err);
    alert(err.message);
  }
}

// Pagination: My History
async function loadMyHistoryPaginated() {
  try {
    const res = await fetch(`${apiUrl}/api/bets/user/${currentEmail}`);
    allUserBets = await res.json();
    allUserBets.reverse();  // ‚úÖ Always show latest bets first
    myHistoryPage = 0;      // ‚úÖ Reset to first page (latest bets)
    renderMyHistoryPage();
  } catch (err) {
    console.error("My History Paginated:", err);
  }
}

function renderMyHistoryPage() {
  const table = document.getElementById("myHistoryTable");
  table.innerHTML = "<tr><th>Round</th><th>Color</th><th>Number</th><th>Amount</th><th>Status</th></tr>";

  const start = myHistoryPage * pageSize;
  const pageBets = allUserBets.slice(start, start + pageSize);

  pageBets.forEach(bet => {
    const r = bet.roundId?.slice(-5) || "-";
    const amt = `‚Çπ${bet.amount}`;
    let status = "‚è≥ Pending";
    if (bet.win === true) status = "‚úÖ Win";
    else if (bet.win === false) status = "‚ùå Lose";
    table.innerHTML += `<tr><td>${r}</td><td>${bet.colorBet || "-"}</td><td>${bet.numberBet != null ? bet.numberBet : "-"}</td><td>${amt}</td><td>${status}</td></tr>`;
  });
}

function nextMyHistoryPage() {
  if ((myHistoryPage + 1) * pageSize < allUserBets.length) {
    myHistoryPage++;
    renderMyHistoryPage();
  }
}

function prevMyHistoryPage() {
  if (myHistoryPage > 0) {
    myHistoryPage--;
    renderMyHistoryPage();
  }
}

// Pagination: Game History
async function fetchGameHistoryPaginated() {
  try {
    const res = await fetch(`${apiUrl}/api/rounds`);
    allRounds = await res.json();
    renderGameHistoryPage();
  } catch (err) {
    console.error("Game History Paginated:", err);
  }
}

function renderGameHistoryPage() {
  const table = document.getElementById("gameHistoryTable");
  table.innerHTML = "<tr><th>Round</th><th>Color</th><th>Number</th><th>Time</th></tr>";

  const start = gameHistoryPage * pageSize;
  const pageRounds = allRounds.slice(start, start + pageSize);

  pageRounds.forEach(r => {
    const t = new Date(r.startTime).toLocaleTimeString();
    const color = r.resultColor ?? "-";
    const number = r.resultNumber != null ? r.resultNumber : "-";
    table.innerHTML += `<tr><td>${r.roundId.slice(-5)}</td><td>${color}</td><td>${number}</td><td>${t}</td></tr>`;
  });
}

function nextGameHistoryPage() {
  if ((gameHistoryPage + 1) * pageSize < allRounds.length) {
    gameHistoryPage++;
    renderGameHistoryPage();
  }
}

function prevGameHistoryPage() {
  if (gameHistoryPage > 0) {
    gameHistoryPage--;
    renderGameHistoryPage();
  }
}

// Initialize
fetchWalletBalance();
startRoundTimer();
loadMyHistoryPaginated();
fetchGameHistoryPaginated();
renderNumberButtons();
</script>


</body>
</html>
