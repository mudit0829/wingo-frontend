<!-- Replace only <script> section from your code with this updated one -->

<script>
const apiUrl = "https://wingo-backend-nqk5.onrender.com";
let selectedColor = null;
let selectedNumber = null;
let totalAmount = 0;
let multiplier = 1;
let currentEmail = localStorage.getItem("userEmail") || "user@example.com";
let currentRoundId = "";
let roundCheckInterval;
let lastRoundId = "";

function selectColor(color) {
  if (isBettingClosed) return; // Prevent betting after 5s
  selectedColor = color;
  selectedNumber = null;
  openBetPopup(color);
}

function openBetPopup(label) {
  document.getElementById("betTitle").textContent = `Place Bet on ${label}`;
  document.getElementById("popup").classList.add("show");
}

function closePopup() {
  document.getElementById("popup").classList.remove("show");
  totalAmount = 0;
  multiplier = 1;
  selectedColor = null;
  selectedNumber = null;
  document.getElementById("totalAmount").textContent = totalAmount;
  document.getElementById("betAmount").value = totalAmount;
}

function addAmount(amount) {
  totalAmount += amount;
  updateAmount();
}

function setMultiplier(mult) {
  multiplier = mult;
  updateAmount();
}

function updateAmount() {
  const calculated = totalAmount * multiplier;
  document.getElementById("totalAmount").textContent = calculated;
  document.getElementById("betAmount").value = calculated;
}

async function fetchWalletBalance() {
  try {
    const res = await fetch(`${apiUrl}/api/users/wallet/${currentEmail}`);
    const data = await res.json();
    const bal = data.wallet ?? data.balance ?? 0;
    document.getElementById("walletAmount").innerText = `₹${bal.toFixed(2)}`;
  } catch (err) {
    console.error("Wallet fetch:", err);
  }
}

let isBettingClosed = false;

async function fetchCurrentRound() {
  try {
    const res = await fetch(`${apiUrl}/api/rounds`);
    const rounds = await res.json();
    if (!rounds || rounds.length === 0) return;
    const round = rounds[0];

    const start = new Date(round.startTime).getTime();
    const now = Date.now();
    const elapsed = Math.floor((now - start) / 1000);
    const left = 30 - elapsed;

    document.getElementById("roundId").textContent = round.roundId.slice(-5);
    document.getElementById("timer").textContent = left > 0 ? `${left}s` : "00s";

    // Disable Betting after 5s
    if (left <= 5 && !isBettingClosed) {
      isBettingClosed = true;
      disableBettingButtons();
      closePopup();  // Close any open bet popup forcibly
    }

    // Reset betting for new round
    if (left > 5 && isBettingClosed && currentRoundId !== round.roundId) {
      isBettingClosed = false;
      enableBettingButtons();
    }

    // If New Round Started
    if (currentRoundId !== round.roundId) {
      currentRoundId = round.roundId;
      fetchWalletBalance();
      loadMyHistory();
      fetchGameHistory();
    }

    // After Round ends, wait for 3 seconds to refresh Wallet & Bets
    if (left <= 0 && lastRoundId !== round.roundId) {
      lastRoundId = round.roundId;
      setTimeout(() => {
        fetchWalletBalance();
        loadMyHistory();
        fetchGameHistory();
      }, 3000);  // 3 seconds buffer after round end
    }

  } catch (err) {
    console.error("Fetch round:", err);
  }
}

function disableBettingButtons() {
  document.querySelectorAll(".color-button, .number-button").forEach(btn => {
    btn.disabled = true;
    btn.style.opacity = 0.5;
    btn.style.cursor = "not-allowed";
  });
}

function enableBettingButtons() {
  document.querySelectorAll(".color-button, .number-button").forEach(btn => {
    btn.disabled = false;
    btn.style.opacity = 1;
    btn.style.cursor = "pointer";
  });
}

function startLiveRoundTracking() {
  fetchCurrentRound();
  clearInterval(roundCheckInterval);
  roundCheckInterval = setInterval(fetchCurrentRound, 1000); // Faster tracking per second
}

async function placeBet() {
  try {
    const amount = parseInt(document.getElementById("betAmount").value);
    if (!currentEmail || !currentRoundId || !amount) throw new Error("Missing fields");
    const payload = {
      email: currentEmail,
      roundId: currentRoundId,
      amount,
      ...(selectedColor && { colorBet: selectedColor }),
      ...(selectedNumber != null && { numberBet: selectedNumber }),
    };
    const res = await fetch(`${apiUrl}/api/bets`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || "Bet failed");
    alert("✅ Bet placed!");
    closePopup();
    fetchWalletBalance();
    loadMyHistory();
  } catch (err) {
    console.error("Place Bet:", err);
    alert(err.message);
  }
}

async function loadMyHistory() {
  try {
    const res = await fetch(`${apiUrl}/api/bets/user/${currentEmail}`);
    const data = await res.json();
    const table = document.getElementById("myHistoryTable");
    table.innerHTML = "<tr><th>Round</th><th>Color</th><th>Number</th><th>Amount</th><th>Status</th></tr>";
    data.reverse().forEach(bet => {
      const r = bet.roundId?.slice(-5) || "-";
      const amt = `₹${bet.amount}`;
      const status = bet.win === true ? "✅ Win" : bet.win === false ? "❌ Lose" : "⏳ Pending";
      if (bet.colorBet) {
        table.innerHTML += `<tr><td>${r}</td><td>${bet.colorBet}</td><td>-</td><td>${amt}</td><td>${status}</td></tr>`;
      }
      if (bet.numberBet != null) {
        table.innerHTML += `<tr><td>${r}</td><td>-</td><td>${bet.numberBet}</td><td>${amt}</td><td>${status}</td></tr>`;
      }
    });
  } catch (err) {
    console.error("My history:", err);
  }
}

async function fetchGameHistory() {
  try {
    const res = await fetch(`${apiUrl}/api/rounds`);
    const rounds = await res.json();
    const table = document.getElementById("gameHistoryTable");
    table.innerHTML = "<tr><th>Round</th><th>Color</th><th>Number</th><th>Time</th></tr>";
    rounds.forEach(r => {
      const t = new Date(r.startTime).toLocaleTimeString();
      const color = r.resultColor ?? "-";
      const number = r.resultNumber != null ? r.resultNumber : "-";
      table.innerHTML += `<tr><td>${r.roundId.slice(-5)}</td><td>${color}</td><td>${number}</td><td>${t}</td></tr>`;
    });
  } catch (err) {
    console.error("Game history:", err);
  }
}

function renderNumberButtons() {
  const grid = document.getElementById("numberGrid");
  grid.innerHTML = "";
  for (let i = 0; i < 10; i++) {
    const btn = document.createElement("button");
    btn.className = "number-button";
    btn.textContent = i;
    btn.onclick = () => {
      if (isBettingClosed) return;  // Disable click after 5s
      selectedNumber = i;
      selectedColor = null;
      openBetPopup(`Number ${i}`);
    };
    grid.appendChild(btn);
  }
}

// Initialize App
fetchWalletBalance();
startLiveRoundTracking();
loadMyHistory();
fetchGameHistory();
renderNumberButtons();
</script>
