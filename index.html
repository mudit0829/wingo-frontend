<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WinGo Game</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    h1 { color: #333; }
    .bet-options button { margin: 5px; padding: 10px 20px; }
    #result { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Welcome to WinGo</h1>
  <div>
    <p><strong>Email:</strong> <span id="emailDisplay">user@example.com</span></p>
    <p><strong>Wallet Balance:</strong> ₹<span id="walletBalance">0</span></p>
    <label for="amount">Bet Amount (₹):</label>
    <input type="number" id="amount" value="100" />
  </div>

  <h3>Choose a Color:</h3>
  <div class="bet-options">
    <button onclick="selectColor('Red')">Red</button>
    <button onclick="selectColor('Green')">Green</button>
    <button onclick="selectColor('Violet')">Violet</button>
  </div>

  <h3>Choose a Number (0-9):</h3>
  <div class="bet-options">
    <script>
      for (let i = 0; i <= 9; i++) {
        document.write(`<button onclick="selectNumber(${i})">${i}</button>`);
      }
    </script>
  </div>

  <button onclick="placeBet()">Place Bet</button>

  <div id="result"></div>

  <script>
    const email = "user@example.com";
    const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2ODg5ZmUxNWE3N2UxMzI2YTY3NDBmZmUiLCJlbWFpbCI6InVzZXJAZXhhbXBsZS5jb20iLCJpYXQiOjE3NTM5NDg3MjAsImV4cCI6MTc1Mzk1OTUyMH0.UTgEb2MlisIpjGxLRmhY-fqm80AEcaTMpUd2p2Mrv3k";

    let selectedColor = null;
    let selectedNumber = null;
    let currentRoundId = null;

    function selectColor(color) {
      selectedColor = color;
      alert(`Color Bet Selected: ${color}`);
    }

    function selectNumber(num) {
      selectedNumber = num;
      alert(`Number Bet Selected: ${num}`);
    }

    async function fetchRoundId() {
      try {
        const res = await fetch('https://wingo-backend-nqk5.onrender.com/api/rounds');
        const data = await res.json();
        currentRoundId = data[data.length - 1].roundId;
      } catch (err) {
        console.error("Failed to fetch roundId:", err);
      }
    }

    async function fetchWallet() {
      try {
        const res = await fetch(`https://wingo-backend-nqk5.onrender.com/api/users/${email}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        document.getElementById('walletBalance').textContent = data.wallet.toFixed(2);
      } catch (err) {
        console.error("Error fetching wallet:", err);
      }
    }

    async function placeBet() {
      await fetchRoundId();
      const amount = parseFloat(document.getElementById("amount").value);
      const effectiveAmount = +(amount * 0.98).toFixed(2);

      if (!amount || amount <= 0) return alert("Enter valid amount");
      if (!selectedColor && selectedNumber === null) return alert("Select a color or number");

      try {
        const payload = {
          email,
          roundId: currentRoundId,
          amount: amount,
          colorBet: selectedColor,
          numberBet: selectedNumber,
        };

        const res = await fetch("https://wingo-backend-nqk5.onrender.com/api/bets", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (res.ok) {
          document.getElementById("result").innerHTML = `
            ✅ Bet placed! <br>
            Bet Amount: ₹${amount} <br>
            Effective (after fee): ₹${effectiveAmount} <br>
            Round: ${currentRoundId}<br>
            Waiting for result...
          `;
          fetchWallet();
        } else {
          throw new Error(data.message || "Failed to place bet");
        }

      } catch (err) {
        console.error("Bet Error:", err);
        document.getElementById("result").textContent = "❌ Failed to place bet: " + err.message;
      }
    }

    window.onload = fetchWallet;
  </script>
</body>
</html>
