<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WinGo Admin Panel</title>
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    button { margin: 5px; padding: 10px; }
    .tabContent { display: none; }
    .activeTab { display: block; }
  </style>
</head>
<body>
  <h2>WinGo Admin Panel</h2>

  <div>
    <button onclick="showTab('resultControl')">Result Control</button>
    <button onclick="showTab('profitLoss')">Profit/Loss</button>
    <button onclick="showTab('timerControl')">Timer Control</button>
    <button onclick="showTab('upcomingRounds')">Upcoming Rounds</button>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- Result Control Tab -->
  <div id="resultControl" class="tabContent">
    <h3>Result Control</h3>
    <input type="text" id="manualRoundId" placeholder="Round ID (e.g., R0012)">
    <select id="manualResultColor">
      <option value="">Select Color</option>
      <option value="Red">Red</option>
      <option value="Green">Green</option>
      <option value="Violet">Violet</option>
    </select>
    <input type="number" id="manualResultNumber" placeholder="Result Number (0-9)">
    <button onclick="setManualResult()">Set Result</button>
  </div>

  <!-- Profit/Loss Tab -->
  <div id="profitLoss" class="tabContent">
    <h3>Profit/Loss Summary</h3>
    <button onclick="fetchProfitLoss()">Refresh Summary</button>
    <p id="profitLossData"></p>
  </div>

  <!-- Timer Control Tab -->
  <div id="timerControl" class="tabContent">
    <h3>Timer Control</h3>
    <button onclick="startTimer()">Start Timer</button>
    <button onclick="stopTimer()">Stop Timer</button>
  </div>

  <!-- Upcoming Rounds Tab -->
  <div id="upcomingRounds" class="tabContent">
    <h3>Upcoming Rounds</h3>
    <table id="upcomingRoundsTable">
      <thead>
        <tr><th>Round ID</th><th>Start Time</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="prevPage()">Previous</button>
    <button onclick="nextPage()">Next</button>
  </div>

  <script>
    const apiBase = 'https://wingo-backend-nqk5.onrender.com';
    let currentPage = 1;

    function showTab(tabId) {
      document.querySelectorAll('.tabContent').forEach(tab => tab.classList.remove('activeTab'));
      document.getElementById(tabId).classList.add('activeTab');
    }

    function logout() {
      localStorage.clear();
      alert('Logged out');
    }

    async function setManualResult() {
      const roundId = document.getElementById('manualRoundId').value.trim();
      const resultColor = document.getElementById('manualResultColor').value;
      const resultNumber = parseInt(document.getElementById('manualResultNumber').value);

      if (!roundId || !resultColor || isNaN(resultNumber)) {
        alert('Please fill all fields correctly.');
        return;
      }

      try {
        const res = await fetch(`${apiBase}/api/admin/manualResult`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ roundId, resultColor, resultNumber })
        });

        const data = await res.json();
        alert(data.message || 'Manual result set.');
      } catch (err) {
        console.error('Set Manual Result Error:', err);
      }
    }

    async function fetchProfitLoss() {
      try {
        const res = await fetch(`${apiBase}/api/admin/profitLoss`);
        const data = await res.json();
        document.getElementById('profitLossData').innerText = 
          `Total Bets: ₹${data.totalBets} | Total Payouts: ₹${data.totalPayouts} | Profit: ₹${data.profit}`;
      } catch (err) {
        console.error('Profit/Loss Fetch Error:', err);
      }
    }

    async function startTimer() {
      try {
        const res = await fetch(`${apiBase}/api/admin/timer/start`, { method: 'POST' });
        const data = await res.json();
        alert(data.message);
      } catch (err) {
        console.error('Start Timer Error:', err);
      }
    }

    async function stopTimer() {
      try {
        const res = await fetch(`${apiBase}/api/admin/timer/stop`, { method: 'POST' });
        const data = await res.json();
        alert(data.message);
      } catch (err) {
        console.error('Stop Timer Error:', err);
      }
    }

    async function loadUpcomingRounds(page = 1) {
      try {
        console.log('Fetching upcoming rounds, Page:', page);
        const res = await fetch(`${apiBase}/api/rounds/upcoming?page=${page}`);
        const data = await res.json();

        console.log('API Response:', data);

        if (!Array.isArray(data)) {
          console.error('Expected array but got:', data);
          return;
        }

        const rows = data.map(round => `
          <tr>
            <td>${round.roundId}</td>
            <td>${new Date(round.startTime).toLocaleString()}</td>
          </tr>
        `).join('');

        document.querySelector('#upcomingRoundsTable tbody').innerHTML = rows;
      } catch (err) {
        console.error('Error loading upcoming rounds:', err);
      }
    }

    function nextPage() {
      currentPage++;
      loadUpcomingRounds(currentPage);
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        loadUpcomingRounds(currentPage);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      showTab('resultControl');
      loadUpcomingRounds();
    });
  </script>
</body>
</html>
