<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WinGo Admin Panel</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h2>WinGo Admin Panel</h2>

  <div>
    <button onclick="generateAutoResult()">Generate Auto Result</button>
    <button onclick="logout()">Logout</button>
  </div>

  <h3>Manual Result Control</h3>
  <div>
    <label for="manualRoundId">Round ID:</label>
    <input type="text" id="manualRoundId" placeholder="Enter Round ID" />

    <label for="manualColor">Color:</label>
    <select id="manualColor">
      <option value="">Select Color</option>
      <option value="Red">Red</option>
      <option value="Green">Green</option>
      <option value="Violet">Violet</option>
    </select>

    <label for="manualNumber">Number:</label>
    <select id="manualNumber">
      <option value="">Select Number</option>
      ${[...Array(10).keys()].map(i => `<option value="${i}">${i}</option>`).join('')}
    </select>

    <button onclick="setManualResult()">Set Manual Result</button>
  </div>

  <h3>Recent Rounds</h3>
  <table id="adminTable">
    <thead>
      <tr><th>Round ID</th><th>Color</th><th>Number</th><th>Time</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const apiBase = 'https://wingo-backend-nqk5.onrender.com';

    function logout() {
      localStorage.clear();
      window.location.href = 'login.html';
    }

    async function generateAutoResult() {
      try {
        const res = await fetch(`${apiBase}/api/cron/run`);
        const data = await res.json();
        alert(data.message || 'Auto Result Generated');
        loadRounds();
      } catch (err) {
        alert('Error generating result');
      }
    }

    async function setManualResult() {
      const roundId = document.getElementById('manualRoundId').value.trim();
      const color = document.getElementById('manualColor').value;
      const number = document.getElementById('manualNumber').value;

      if (!roundId || !color || number === "") {
        alert("Please fill all fields correctly");
        return;
      }

      try {
        const res = await fetch(`${apiBase}/api/cron/admin/setResult`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ roundId, color, number: parseInt(number) })
        });

        const data = await res.json();
        alert(data.message || 'Manual Result Set');
        loadRounds();
      } catch (err) {
        alert('Error setting manual result');
      }
    }

    async function loadRounds() {
      try {
        const res = await fetch(`${apiBase}/api/rounds`);
        const data = await res.json();

        const rows = data.slice(-20).reverse().map(round => `
          <tr>
            <td>${round.roundId || '-'}</td>
            <td>${round.resultColor || '-'}</td>
            <td>${round.resultNumber != null ? round.resultNumber : '-'}</td>
            <td>${new Date(round.startTime).toLocaleTimeString()}</td>
          </tr>
        `).join('');

        document.querySelector('#adminTable tbody').innerHTML = rows;
      } catch (err) {
        console.error(err);
      }
    }

    loadRounds();
    setInterval(loadRounds, 10000);
  </script>
</body>
</html>
