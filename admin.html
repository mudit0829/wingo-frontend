<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - WinGo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; padding: 0; }
    h2 { margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    button { padding: 5px 10px; margin: 2px; }
    .flex { display: flex; flex-wrap: wrap; gap: 10px; }
    .input-group { display: flex; align-items: center; gap: 5px; }
    @media (max-width: 600px) {
      table, th, td { font-size: 12px; }
      button { font-size: 12px; }
    }
  </style>
</head>
<body>
  <h1>Admin Panel - WinGo</h1>

  <div class="flex">
    <button onclick="fetchProfitLoss()">Refresh Profit/Loss</button>
    <button onclick="startTimer()">Start Timer</button>
    <button onclick="stopTimer()">Stop Timer</button>
  </div>

  <h2>Profit/Loss Summary</h2>
  <div id="profitLoss">Loading...</div>

  <h2>Upcoming Rounds</h2>
  <table id="upcomingRoundsTable">
    <thead>
      <tr>
        <th>Round ID</th>
        <th>Start Time</th>
        <th>Set Result</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="loadMoreUpcoming()">Load More</button>

  <script>
    let upcomingPage = 0;
    const PAGE_SIZE = 10;

    async function fetchProfitLoss() {
      const res = await fetch('https://wingo-backend-nqk5.onrender.com/api/admin/profitLoss');
      const data = await res.json();
      document.getElementById('profitLoss').innerText = `Total Bets: ₹${data.totalBets} | Payouts: ₹${data.totalPayouts} | Profit: ₹${data.profit}`;
    }

    async function loadUpcomingRounds() {
      const res = await fetch(`https://wingo-backend-nqk5.onrender.com/api/rounds/upcoming?page=${upcomingPage}&pageSize=${PAGE_SIZE}`);
      const data = await res.json();
      const tbody = document.getElementById('upcomingRoundsTable').querySelector('tbody');

      data.rounds.forEach(round => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${round.roundId}</td>
          <td>${new Date(round.startTime).toLocaleString()}</td>
          <td>
            <div class="input-group">
              <select id="color-${round.roundId}">
                <option value="Red">Red</option>
                <option value="Green">Green</option>
                <option value="Violet">Violet</option>
              </select>
              <input type="number" id="number-${round.roundId}" min="0" max="9" style="width:50px;">
              <button onclick="submitManualResult('${round.roundId}')">Set</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function loadMoreUpcoming() {
      upcomingPage++;
      loadUpcomingRounds();
    }

    async function submitManualResult(roundId) {
      const color = document.getElementById(`color-${roundId}`).value;
      const number = parseInt(document.getElementById(`number-${roundId}`).value);

      if ((color === 'Violet' && number !== 0 && number !== 5) ||
          (color === 'Red' && ![1,3,7,9].includes(number)) ||
          (color === 'Green' && ![2,4,6,8].includes(number))) {
        alert('Invalid Color-Number Combination!');
        return;
      }

      const res = await fetch('https://wingo-backend-nqk5.onrender.com/api/cron/admin/setResult', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ roundId, resultColor: color, resultNumber: number })
      });

      const data = await res.json();
      if (res.ok) {
        alert('Result Set Successfully');
      } else {
        alert(data.message || 'Error setting result');
      }
    }

    async function startTimer() {
      await fetch('https://wingo-backend-nqk5.onrender.com/api/admin/timer/start', { method: 'POST' });
      alert('Timer Started');
    }

    async function stopTimer() {
      await fetch('https://wingo-backend-nqk5.onrender.com/api/admin/timer/stop', { method: 'POST' });
      alert('Timer Stopped');
    }

    fetchProfitLoss();
    loadUpcomingRounds();
  </script>
</body>
</html>
