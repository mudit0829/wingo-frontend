<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WinGo Admin Panel</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    button { margin: 5px; padding: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .tab { display: none; }
    .tab.active { display: block; }
    .tab-buttons button { margin-right: 10px; }
  </style>
</head>
<body>

  <h2>WinGo Admin Panel</h2>

  <div class="tab-buttons">
    <button onclick="showTab('controlTab')">Result Control</button>
    <button onclick="showTab('profitLossTab')">Profit/Loss</button>
    <button onclick="showTab('timerTab')">Timer Control</button>
    <button onclick="showTab('upcomingRoundsTab')">Upcoming Rounds</button>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- Result Control Tab -->
  <div id="controlTab" class="tab active">
    <h3>Manual Result Control</h3>
    <label>Round ID: <input type="text" id="manualRoundId" /></label><br><br>
    <label>Color Result:
      <select id="manualColor">
        <option value="">Select</option>
        <option value="Red">Red</option>
        <option value="Green">Green</option>
        <option value="Violet">Violet</option>
      </select>
    </label><br><br>
    <label>Number Result:
      <select id="manualNumber">
        <option value="">Select</option>
        ${[...Array(10).keys()].map(n => `<option value="${n}">${n}</option>`).join('')}
      </select>
    </label><br><br>
    <button onclick="submitManualResult()">Submit Result</button>
  </div>

  <!-- Profit/Loss Tab -->
  <div id="profitLossTab" class="tab">
    <h3>Profit/Loss Summary</h3>
    <div id="profitLossSummary">
      <p>Total Bets: ₹0</p>
      <p>Total Payouts: ₹0</p>
      <p>Profit: ₹0</p>
    </div>
    <button onclick="fetchProfitLoss()">Refresh</button>
  </div>

  <!-- Timer Control Tab -->
  <div id="timerTab" class="tab">
    <h3>Timer Controls</h3>
    <button onclick="startTimer()">Start Timer</button>
    <button onclick="stopTimer()">Stop Timer</button>
  </div>

  <!-- Upcoming Rounds Tab -->
  <div id="upcomingRoundsTab" class="tab">
    <h3>Upcoming Rounds</h3>
    <table id="upcomingTable">
      <thead>
        <tr><th>Round ID</th><th>Start Time</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="prevUpcomingPage()">Previous</button>
    <button onclick="nextUpcomingPage()">Next</button>
  </div>

  <script>
    const apiBase = 'https://wingo-backend-nqk5.onrender.com';
    let upcomingPage = 0;

    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'login.html';
    }

    async function submitManualResult() {
      const roundId = document.getElementById('manualRoundId').value.trim();
      const color = document.getElementById('manualColor').value;
      const number = document.getElementById('manualNumber').value;

      if (!roundId || !color || number === "") {
        alert('Please select Round ID, Color, and Number');
        return;
      }

      try {
        const res = await fetch(`${apiBase}/api/cron/manualResult`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ roundId, color, number: parseInt(number) })
        });
        const data = await res.json();
        alert(data.message || 'Result submitted');
      } catch (err) {
        console.error('Manual Result Error:', err);
        alert('Failed to submit result');
      }
    }

    async function fetchProfitLoss() {
      try {
        const res = await fetch(`${apiBase}/api/admin/profitLoss`);
        const data = await res.json();
        document.getElementById('profitLossSummary').innerHTML = `
          <p>Total Bets: ₹${data.totalBets}</p>
          <p>Total Payouts: ₹${data.totalPayouts}</p>
          <p>Profit: ₹${data.profit}</p>
        `;
      } catch (err) {
        console.error('Profit/Loss Error:', err);
        alert('Failed to fetch profit/loss');
      }
    }

    async function startTimer() {
      try {
        await fetch(`${apiBase}/api/admin/timer/start`, { method: 'POST' });
        alert('Timer started');
      } catch (err) {
        alert('Failed to start timer');
      }
    }

    async function stopTimer() {
      try {
        await fetch(`${apiBase}/api/admin/timer/stop`, { method: 'POST' });
        alert('Timer stopped');
      } catch (err) {
        alert('Failed to stop timer');
      }
    }

    async function loadUpcomingRounds() {
      try {
        const res = await fetch(`${apiBase}/api/rounds/upcoming?page=${upcomingPage}`);
        const response = await res.json();
        const data = response.rounds || response;  // <-- Safe Fallback Fix

        const rows = data.map(round => `
          <tr>
            <td>${round.roundId}</td>
            <td>${new Date(round.startTime).toLocaleTimeString()}</td>
          </tr>
        `).join('');

        document.querySelector('#upcomingTable tbody').innerHTML = rows;
      } catch (err) {
        console.error('Upcoming Rounds Load Error:', err);
      }
    }

    function nextUpcomingPage() {
      upcomingPage++;
      loadUpcomingRounds();
    }

    function prevUpcomingPage() {
      if (upcomingPage > 0) {
        upcomingPage--;
        loadUpcomingRounds();
      }
    }

    // Initialize
    loadUpcomingRounds();
    fetchProfitLoss();
  </script>

</body>
</html>
