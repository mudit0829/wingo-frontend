<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WinGo Admin Panel</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h2>WinGo Admin Panel</h2>

  <div>
    <button onclick="showTab('recentRounds')">Recent Rounds</button>
    <button onclick="showTab('upcomingRounds')">Upcoming Rounds</button>
    <button onclick="showTab('profitLoss')">Profit/Loss</button>
    <button onclick="generateResult()">Generate Result</button>
    <button onclick="logout()">Logout</button>
  </div>

  <div id="recentRounds" class="tab">
    <h3>Recent Rounds</h3>
    <table id="adminTable">
      <thead>
        <tr><th>Round ID</th><th>Result</th><th>Time</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="upcomingRounds" class="tab" style="display:none;">
    <h3>Upcoming Rounds</h3>
    <table id="upcomingTable">
      <thead>
        <tr><th>Round ID</th><th>Start Time</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="prevUpcomingPage()">Prev</button>
    <button onclick="nextUpcomingPage()">Next</button>
    <p id="upcomingPageInfo"></p>
  </div>

  <div id="profitLoss" class="tab" style="display:none;">
    <h3>Profit/Loss Summary</h3>
    <p id="profitLossData">Loading...</p>
    <button onclick="loadProfitLoss()">Refresh</button>
  </div>

  <h3>Manual Result Control</h3>
  <div>
    <label>Round ID: <input type="text" id="manualRoundId" placeholder="Enter Round ID"></label>
    <label>Color: 
      <select id="manualColor">
        <option value="">Select</option>
        <option value="Red">Red</option>
        <option value="Green">Green</option>
        <option value="Violet">Violet</option>
      </select>
    </label>
    <label>Number: <input type="number" id="manualNumber" min="0" max="9"></label>
    <button onclick="submitManualResult()">Submit Result</button>
  </div>

  <script>
    const apiBase = 'https://wingo-backend-nqk5.onrender.com';
    let upcomingPage = 0;
    const pageSize = 10;

    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.style.display = 'none');
      document.getElementById(tabId).style.display = 'block';
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'login.html';
    }

    async function generateResult() {
      try {
        const res = await fetch(`${apiBase}/api/cron/generateResult`, { method: 'POST' });
        const data = await res.json();
        alert(data.message || 'Result generated');
        loadRecentRounds();
      } catch (err) {
        alert('Error generating result');
      }
    }

    async function loadRecentRounds() {
      try {
        const res = await fetch(`${apiBase}/api/rounds`);
        const data = await res.json();
        const rows = data.map(round => `
          <tr>
            <td>${round.roundId || '-'}</td>
            <td>${round.resultColor ?? '-'} ${round.resultNumber ?? ''}</td>
            <td>${new Date(round.startTime).toLocaleTimeString()}</td>
          </tr>`).join('');
        document.querySelector('#adminTable tbody').innerHTML = rows;
      } catch (err) {
        console.error(err);
      }
    }

    async function loadUpcomingRounds() {
      try {
        const res = await fetch(`${apiBase}/api/rounds/upcoming?page=${upcomingPage}&pageSize=${pageSize}`);
        const data = await res.json();
        const rows = data.rounds.map(round => `
          <tr>
            <td>${round.roundId}</td>
            <td>${new Date(round.startTime).toLocaleTimeString()}</td>
          </tr>`).join('');
        document.querySelector('#upcomingTable tbody').innerHTML = rows;
        document.getElementById('upcomingPageInfo').innerText = `Page ${upcomingPage + 1} of ${Math.ceil(data.total / pageSize)}`;
      } catch (err) {
        console.error(err);
      }
    }

    function nextUpcomingPage() {
      upcomingPage++;
      loadUpcomingRounds();
    }

    function prevUpcomingPage() {
      if (upcomingPage > 0) {
        upcomingPage--;
        loadUpcomingRounds();
      }
    }

    async function loadProfitLoss() {
      try {
        const res = await fetch(`${apiBase}/api/admin/profitLoss`);
        const data = await res.json();
        document.getElementById('profitLossData').innerText = `Total Bets: ₹${data.totalBets}, Total Payouts: ₹${data.totalPayouts}, Profit: ₹${data.profit}`;
      } catch (err) {
        console.error(err);
        document.getElementById('profitLossData').innerText = 'Failed to load';
      }
    }

    async function submitManualResult() {
      const roundId = document.getElementById('manualRoundId').value;
      const color = document.getElementById('manualColor').value;
      const number = parseInt(document.getElementById('manualNumber').value);

      if (!roundId || !color || isNaN(number)) {
        alert('Please fill all fields');
        return;
      }

      try {
        const res = await fetch(`${apiBase}/api/cron/manualResult`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ roundId, color, number })
        });

        const data = await res.json();
        alert(data.message || 'Manual Result Submitted');
        loadRecentRounds();
      } catch (err) {
        console.error(err);
        alert('Failed to submit manual result');
      }
    }

    // Initialize
    loadRecentRounds();
    loadUpcomingRounds();
    loadProfitLoss();
    setInterval(loadRecentRounds, 10000);
  </script>
</body>
</html>
